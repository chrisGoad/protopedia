<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Prototype Jungle</title>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top:130px;
        left:0px;
        width:740px;
        height:400px;
        border:solid thin black;
    }
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<link rel="stylesheet" type="text/css"  href="/style.css">
<script>
if (!Object.create) location.href = "archaicbrowser.html";
</script>
</head>
<body>

<script src="/js/pj.js"></script>

<script src="/js/util.js"></script>

<script src="/js/om.js"></script>
<script src="/js/instantiate.js"></script>
<script src="/js/externalize.js"></script>
<script src="/js/jquery.js"></script>
<script src="/js/jqprotos.js"></script>

<script src="/js/geom.js"></script>
<script src="/js/draw.js"></script>
<script src="/js/shapes.js"></script>
<script src="/js/page.js"></script>

<script src="/js/error.js"></script>
<script src="/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
    
var cb;
var editor;
var itemPath;
(function (__pj__){
 
  var om = __pj__.om;
  var draw = __pj__.draw;
  var page = __pj__.page
 
//var theItemPath = '/pj/repoTest2/examples/Nested';
var buildTimeout = 4000;
var buildDone;
//var editor;
// var itemPath;
   
  page.elementsToHideOnError = [];


  function layout() {
   
    var awinwid = $(window).width();
    var awinht = $(window).height();
    var topht = $('#topbarOuter').height();
    var eht = awinht - 50 - topht;
    console.log(topht);
    $('#editor').css({height:eht+"px",top:(topht+10)+"px"});
  }

function checkAuth() {
  if (!itemPath) {
    return "No item path; the url should include ?item=/handle/repo ...";
  }
// strip off the handle and repo
  var ip = om.stripInitialSlash(itemPath);
  var spl = ip.split("/");
  var h = localStorage.handle;
  if (spl.length<3) {
    return "The item path must include at least /handle/repo/name";
  }
  if (spl[0] != h) {
     return "You cannot build items outside of your tree /"+h;
  }
}

function initialText() {
 // strip off the handle and repo
  var ip = om.stripInitialSlash(itemPath);
  var spl = ip.split("/");
  spl.shift();
  spl.shift();
  var ipth = "/"+spl.join("/");
  return  '\n\
  // The code that defines the item \n\
__pj__.om.restore([], // insert dependencies here \n\
  function () {\n\
    // handy variables\n\
    var om = __pj__.om; \n\
    var geom = __pj__.geom;\n\
\n\
    // the item being built \n\
    var item = __pj__.set("'+ipth+'",geom.Shape.mk());  \n\
\n\
    // the code to construct the item goes here \n\
    // for example: item.set("circle",geom.Circle.mk({radius:100})) \n\
\n\
    om.save(item); \n\
    }\n\
);\n\
';

}

function setError(txt,errOnly) {
  if (!errOnly) {
    $('#building').hide();
    $('#saved').hide();
     $('#editor').hide();
  }
   $('#error').html(txt);
   layout();
}

function setSaved(v) {
  if (v) {
    $('#saved').html('Saved');
    $('#itemkind').html('Item ');
    $('#stale').html('');
  } else {
    $('#saved').html('');
    $('#stale').html('*');
   
  }
  layout();
}
function buildError(url) {
  if (!buildDone) {
   __pj__.page.genError("<span style='color:red'>Error</span>: the build from <a href='"+url+"'>"+url+"</a> failed, either because the file is missing, or because there was a JavaScript error. \
                        JavaScript debuggers are available in all modern browsers. Edit, and try again.");
  }
}

  function saveSource(cb) {
    var dt = {path:itemPath,source:editor.getValue()};
    om.ajaxPost("/api/toS3",dt,function (rs) {
      if (rs.status != "ok") {
        setError("Save failed. (Internal error)");
      } else {
        setSaved(true);
        if (cb) {
          cb();
        }
      }
    });
  }
  
  function getSource(cb) {
    // I'm not sure why, but the error call back is being called, whether or not the file is present
    function scb(rs) {
      if (rs.statusText == "OK") {
        cb(rs.responseText);
      } else {
        cb(undefined);
      }
    }
   
    var opts = {url:itemSource,cache:false,contentType:"application/javascript",dataType:"string",type:"GET",success:scb,error:scb};
    $.ajax(opts);
    //code
  }
  
  function doTheBuild() {
  //  setTimeout(function () {buildError(url);} ,buildTimeout);
    saveSource(function () {
      //var url = "http://s3.prototypejungle.org"+itemPath;//+"/source.js";
      //var sourceUrl = url + "/source.js"
      om.customSave = function (built) {
        buildDone = true;
        built.__source__ =  itemSource;
        var whenSaved = function (srs) {
          if (srs.status == "fail") {
            if (srs.msg == "busy") {
              emsg = "The server is overloaded just now. Please try again later";
            } else if ((srs.msg=="noSession")||(srs.msg == "timedOut")) {
              var emsg = 'Your session has timed out. Please sign in again.';
              page.logout();
            } else {
              emsg = "unexpected error- "+srs.msg; //should not happen
            }
            page.genError("Error: "+emsg);
            return;
          }
          var dst = "/build_results?source="+itemUrl;//+"&item="+itemPath;
          location.href = dst;
          return;
        }
        var paths = om.unpackUrl(itemUrl);
        built.__origin__ = itemUrl;
        om.s3Save(built,paths,whenSaved);
      }
      om.getScript(itemSource, function (rs) {
        if (!buildDone) {
          setError("The build failed because there was a JavaScript error. JavaScript debuggers are available in all modern browsers - retry the build with the debugger on, and/or with edits.",1);
        }
      });
    });
  }


  $('document').ready(function () {
    page.genTopbar($('#topbar'),{includeTitle:1,toExclude:'build'});
    om.checkSession(function (rs) {
       if (rs.status!="ok") {
          setError("You must be signed in to do a build");
          return;
        }
        var q = om.parseQuerystring();
        itemPath = q.item;
        itemUrl = "http://s3.prototypejungle.org"+itemPath;
        itemSource = itemUrl + "/source.js";
        $('#whichItem').html(itemPath);
        var ck = checkAuth();
        if (typeof ck == "string") {
          setError(ck);
          return;
        }
        getSource(function (rs) {
          if (rs) {
            itxt = rs;
            setSaved(true);
          } else {
            var itxt = initialText();
            setSaved(false);
            $('#itemkind').html("New item ");
          }
          editor = ace.edit("editor");
          editor.setTheme("ace/theme/TextMate");
          editor.getSession().setMode("ace/mode/javascript");
          editor.setValue(itxt);
          editor.on("change",function (){console.log("change");setSaved(false);$('#error').html('');layout();});
         
          $('#buildButton').click(function () {
              doTheBuild();
          });
          $('#saveButton').click(function () {
            saveSource();
          
          });
        });
        layout();
    });
  });
  
  
  $(window).resize(function() {
      layout();
    });   


})(__pj__);
</script>

<div id="outerContainer">
  <div id="topbarOuter" style="padding-bottom:30px"><span class="mainTitle">Prototype Jungle</span>
    <div class="button" id="saveButton">Save Code</div><div class="button" id="buildButton">Build</div>
        <div id = "topbarInner" style="float:right"></div>
        <div id="building" style="padding-top:10px"><span id="itemkind">Item </span><span id="whichItem" style="font-weight:bold"></span>
        <span id="stale">*</span></div>
        <div id="saved" style="padding-top:10px;font-style:italic"></div>
        <div id="error"  style="padding:20px"></div>
 </div>
  <div id="editor"></div>
</div>

</body>
</html>

    