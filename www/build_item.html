<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Prototype Jungle</title>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top:100px;
        width:700px;
        height:400px;
    }
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<link rel="stylesheet" type="text/css"  href="/style.css">
<script>
if (!Object.create) location.href = "archaicbrowser.html";
</script>
</head>
<body>

<script src="/js/pj.js"></script>

<script src="/js/util.js"></script>

<script src="/js/om.js"></script>
<script src="/js/instantiate.js"></script>
<script src="/js/externalize.js"></script>
<script src="/js/jquery.js"></script>
<script src="/js/jqprotos.js"></script>

<script src="/js/geom.js"></script>
<script src="/js/draw.js"></script>
<script src="/js/shapes.js"></script>
<script src="/js/page.js"></script>

<script src="/js/error.js"></script>
<script src="/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
    
var cb;

(function (__pj__){
 
  var om = __pj__.om;
  var draw = __pj__.draw;
  var page = __pj__.page
  
  page.elementsToHideOnError = [];

function buildError(url) {
  if (!buildDone) {
   __pj__.page.genError("<span style='color:red'>Error</span>: the build from <a href='"+url+"'>"+url+"</a> failed, either because the file is missing, or because there was a JavaScript error. JavaScript debuggers are available in all modern browsers.");
  }
}

var theItemPath = '/pj/repoTest2/examples/Nested';
var buildTimeout = 4000;
var buildDone,editor;
  
  function saveSource(itemPath) {
    var dt = {path:itemPath,source:editor.getValue()};
    om.ajaxPost("/api/toS3",dt,function (rs) {
      var abc = 22;
    });
  }
  
  function doTheBuild(itemPath) {
    setTimeout(function () {buildError(url);} ,buildTimeout);
    om.customSave = function (built) {
      buildDone = true;
      var url = "http://s3.prototypejungle.org"+itemPath+"/source.js";
      built.__source__ = url;
      var whenSaved = function (srs) {
        if (srs.status == "fail") {
          if (srs.msg == "busy") {
            emsg = "The server is overloaded just now. Please try again later";
          } else if ((srs.msg=="noSession")||(srs.msg == "timedOut")) {
            var emsg = 'Your session has timed out. Please sign in again.';
            page.logout();
          } else {
            emsg = "unexpected error- "+srs.msg; //should not happen
          }
          page.genError("Error: "+emsg);
          return;
        }
        var dst = "/build_results?source="+url+"&item="+paths.url;
        location.href = dst;
        return;
      }
      built.__origin__ = paths.url;
      om.s3Save(built,paths,whenSaved);
    }
    om.getScript(url);

  }

  $('document').ready(function () {
    om.checkSession(function (rs) {
        page.genTopbar($('#topbar'),{includeTitle:1,toExclude:'build'});
        var handle = localStorage.handle;
        if (!handle) {
          var nsi = $('#notSignedInDiv');
          nsi.show();
        }
        editor = ace.edit("editor");
        editor.setTheme("ace/theme/TextMate");
        editor.getSession().setMode("ace/mode/javascript");
  
       
        $('#buildButton').click(function () {
            doTheBuild(theItemPath);
        });
        $('#saveButton').click(function () {
          saveSource(theItemPath);
        
        });
    });
  });

})(__pj__);
</script>

<div id="outerContainer">
  <div id="topbarOuter" style="padding-bottom:30px"><span class="mainTitle">Prototype Jungle</span>
    <div class="button" id="saveButton">Save</div><div class="button" id="buildButton">Build</div>
        <div id = "topbarInner" style="float:right"></div>
  </div>
  <div id="editor"></div>
  <div id="error"></div>
</div>

</body>
</html>

    