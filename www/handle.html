<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PrototypeJungle</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="https://login.persona.org/include.js"></script>
<link rel="stylesheet" type="text/css"  href="/style.css"/> 
<body>

 <script src="/js/pj.js"></script>
 
<script src="/js/util.js"></script>
<script src="/js/om.js"></script>
<script src="/js/login.js"></script>
<script src="/js/page.js"></script>
<script src="/js/error.js"></script>

<script>
(function () {
  var page = __pj__.page;
  var om = __pj__.om;
  $('document').ready(function () {
    // check if logged in with persona
    var page = __pj__.page;
    var chandle = om.storage.handle;
    var nm = om.mainName(om.storage.userName);
    //var nm = om.afterChar(fnm,"_"); // strip off "twitter_", "persona_" or whatever
    
    $('#welcome').html("Welcome "+nm);
     var inp = $('#handleInput');
     if (chandle) {
        inp.attr('value',chandle);
     } else {
       inp.attr('value',nm);
     }
     $('#taken').hide();
            // location.href = '/';
    page.genTopbar($('#topbar'),{includeTitle:1});
    var onEnter = function () {
        $('#taken').hide();
        var vl = inp.attr('value');
        if (vl) {
          if (!om.checkName(vl)) {
            $('#taken').show();
            $('#taken').html("Handles must include only letters, numerals and underbars, and may not start with a numeral");
            return;
          }
          // todo check of right form
          var dt = {handle:vl};
          om.ajaxPost('/api/setHandle',dt,function (rs) {
            if (rs.status == "ok") {
              $('#mainDiv').hide();
              $('#ok').html("Ok, <b>"+vl+"</b> is now your handle");
              om.storage.handle=vl;
            } else {
              $('#taken').show();
              $('#taken').html("That handle is taken. Please choose another");
            }
          });
        }
      }
     $('#okButton').click(onEnter);
     om.setOnEnter(inp,onEnter);
    }); 
})();

</script>
<div id="outerContainer"> 
  <div id="topbar"></div>
  <div id="error"></div>
  <div id="mainDiv">
    <div style="width:100%;text-align:center"><b id="welcome">Welcome</b></div>
     <p> Please select your handle:  (your items will appear under http://s3.prototypejungle.org/item/<i>handle</i>/)</p>
     <br/>
      <input id="handleInput" type="text" style="margin-left:20px;width:400px"/>
      <br/>
      <div class="button" style="margin-left:20px;margin-top:20px" id="okButton">Ok</div>

  </div>
  <div id="taken"></div>
  <div id="ok"></div>
</div>

</body>
</html>
