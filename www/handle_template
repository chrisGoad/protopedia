<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PrototypeJungle</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="https://login.persona.org/include.js"></script>
<link rel="stylesheet" type="text/css"  href="http://prototypejungle.org/style.css"/> 
<body>
  
<script src="http://{{domain}}/js/pjloginout-{{pjloginout_version}}.min.js"></script>


<script>
(function (__pj__) {
  var ui = __pj__.ui;
  var om = __pj__.om;
  $('document').ready(function () {
    // check if logged in with persona
    ui.genTopbar($('#topbar'),{includeTitle:1,toExclude:{file:1}});
    var chandle = localStorage.handle;
    if (!localStorage.userName) {
      $('#mainDiv').hide();
      $('#taken').html('Unexpected internal issue: you should be logged in to reach this page');
      return;
    }
    var nm = ui.mainName(localStorage.userName);
    //var nm = om.afterChar(fnm,"_"); // strip off "twitter_", "persona_" or whatever
   
    $('#welcome').html("Welcome "+nm);
     var inp = $('#handleInput');
     if (chandle) {
        inp.prop('value',chandle);
     } else {
       inp.prop('value',nm);
     }
     $('#taken').hide();
            // location.href = '/';
    var onEnter = function () {
        $('#taken').hide();
        var vl = inp.prop('value');
        if (vl) {
          if (!om.checkName(vl)) {
            $('#taken').show();
            $('#taken').html("Handles must include only letters, numerals and underbars, and may not start with a numeral");
            return;
          }
          // todo check of right form
          var dt = {handle:vl};
          om.ajaxPost('/api/setHandle',dt,function (rs) {
            if (rs.status == "ok") {
              $('#mainDiv').hide();
              localStorage.handle=vl;
              location.href = "http://prototypejungle.org/newuser#signedIn=1&handle="+vl;
            } else {
              $('#taken').show();
              $('#taken').html("That handle is taken. Please choose another");
            }
          });
        }
      }
     $('#okButton').click(onEnter);
     ui.setOnEnter(inp,onEnter);
    }); 
})(prototypeJungle);

</script>

<div id="outerContainer">
  <div id="topbar">
    <div id="topbarOuter" style="padding-bottom:30px"><a href="http://prototypejungle.org" class="mainTitle">PrototypeJungle</a>
      <div id = "topbarInner" style="float:right"></div>
    </div>
  </div>
  <div id="error"></div>
  <div id="mainDiv">
    <div style="width:100%;text-align:center"><b id="welcome">Welcome</b></div>
     <p> Please select your handle:  (your items will appear under http://prototypejungle.org/<i>handle</i>/)</p>
     <br/>
      <input id="handleInput" type="text" style="margin-left:20px;width:400px"/>
      <br/>
      <div class="button" style="margin-left:20px;margin-top:20px" id="okButton">Ok</div>

  </div>
  <div id="taken" class="error" style="padding:20px"></div>
</div>

</body>
</html>
