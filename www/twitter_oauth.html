<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PrototypeJungle</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<link rel="stylesheet" type="text/css"  href="/style.css"/> 
<body style="background-color:#eeeeee">

 <script src="/js/pj.js"></script>
 
<script src="/js/util.js"></script>
<script src="/js/om.js"></script>
<script src="/js/login.js"></script>
<script src="/js/page.js"></script>
<script src="/js/error.js"></script>

<script>
// This is where twitter redirects after the user has authorized PrototypeJungle
var drs;// for debugging
(function () {
    var qs = om.parseQuerystring();
    var denied = qs.denied;
    if (denied) {
      location.href = "/denied.html";

      return;
    }
    var tokenForComparison = qs.oauth_token; // just for checking
    var tkj = om.storage.twitterToken;
    var tk = JSON.parse(tkj);
    tk.verifier =  qs.oauth_verifier;
    var url = "/api/setTwitterToken";
    if (om.storage.signingInWithTwitter) {
      tk.signingIn = 1;
    }
    var data = JSON.stringify(tk);
    
    om.ajaxPost(url,data,function (rs) {
      if (rs.status== "ok") {
     // if (om.storage.signingInWithTwitter) {
        var vl = rs.value;
        if (vl.accepted_terms || 1) {
          om.storage.sessionId = vl.sessionId;
          om.storage.userName = vl.userName
          var newu = vl.new_user;
          if (newu) {
            location.href = '/handle.html'
          } else {
            om.storage.handle = vl.handle;
            location.href = '/'; 
          }
        
          return;
        }
      } else {
        alert("Twitter sign in failure")
      }

    });
  })();
 // $('document').ready(function () {
  //  __pj__.page.genTopbar($('#topbar'),{includeTitle:1});
   
 // });
</script>
<div id="outerContainer"> 
  <div id="topbar"></div>
  <div id="error"></div>
  <div id="mainDiv">
    <center>Redirecting ...</center>
  </div>
  <div id="results"></div>


</body>
</html>

<!--

import ops.oauth_twitter
oauth_twitter = ops.oauth_twitter




def emitPage(webin):
  #sess = webin.session
  #user = sess.user
  qs = webin.queryString
  if qs:
    qd = urlparse.parse_qs(qs)
    #print "QD",qd
    tokena = qd.get('oauth_token',None)
    if tokena:
      token = tokena[0]
      verifier = qd['oauth_verifier'][0]
      return emitRedirect(verifier,token)
    
    """
    dir = "/mnt/ebs1/imagediver/tokens/"
    uname = misc.pathLast(user)
    fln = dir+uname
    f = open(fln)
    tkj = f.read()
    f.close()
    tk = json.loads(tkj)
    token_secret = tk['oauth_token_secret']
    access_token = oauth_tumblr.getAccessToken(verifier,token,token_secret)
    #print "ACCESS TOKEN:",access_token
    userD = models.loadUserD(user)
    atkj = json.dumps(access_token)
    userD.tumblr_token = atkj
    userD.dynsave(False)
    topic = tk.get("topic",None)
    if topic:
      topic = str(topic)
      url = "/post_to_tumblr?topic="+topic
      return redirectResponse(url)
    """
  return gen.genHtmlPage(webin,"Twitter access was denied.",styleSheets=styleSheets,pageTitle="Access Denied")

-->

 
  

